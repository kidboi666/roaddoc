# 로드닥 (RoadDoc) MVP 스펙

> 도로 위 AI 주치의 - 운전 중 음성으로 도로교통법 Q&A

---

## 프로젝트 개요

### 핵심 컨셉

운전 중 애매한 도로교통법을 **음성으로 질문**하면 **AI가 답변**하는 앱

### 타겟 사용자

- 장거리/고속도로 운전자
- 초보 운전자
- 애매한 상황에서 확인하고 싶은 일반 운전자

### MVP 범위

- 음성 녹음 (expo-audio)
- 음성 인식 (OpenAI Whisper API)
- AI 답변 생성 (GPT-4o-mini)
- 음성 출력 (expo-speech)

---

## 브랜딩

| 항목 | 내용 |
|------|------|
| 앱 이름 | 로드닥 |
| 영문 | RoadDoc |
| 슬로건 | "도로 위 AI 주치의" |
| 패키지명 | `com.logmind.roaddoc` |
| 초기 버전 | 0.1.0 |

---

## 기술 스택

| 영역 | 기술 | 용도 |
|------|------|------|
| 프레임워크 | Expo (~54.0.0) | 앱 기본 구조 |
| 라우팅 | Expo Router (~4.0.0) | 화면 네비게이션 |
| UI 라이브러리 | gluestack-ui v3 | 모던 UI 컴포넌트 |
| 스타일링 | NativeWind (Tailwind CSS) | 유틸리티 기반 스타일링 |
| 오디오 녹음 | expo-audio | 음성 녹음 |
| STT | OpenAI Whisper API | 음성 → 텍스트 |
| TTS | expo-speech (~13.0.0) | 텍스트 → 음성 (디바이스 기본 TTS) |
| AI | OpenAI API (^4.50.0) | GPT-4o-mini 기반 답변 생성 |
| 상태관리 | Zustand (^4.5.0) | 대화 상태 관리 |

---

## 패키지 목록

```json
{
  "dependencies": {
    "expo": "~54.0.0",
    "expo-router": "~4.0.0",
    "expo-audio": "~1.1.1",
    "expo-speech": "~13.0.0",
    "openai": "^4.50.0",
    "zustand": "^4.5.0",
    "@react-native-async-storage/async-storage": "^2.1.0",
    "nativewind": "^4.0.0",
    "tailwindcss": "^3.4.0"
  }
}
```

---

## 프로젝트 구조

```
roaddoc/
├── app/
│   ├── _layout.tsx          # 루트 레이아웃
│   ├── index.tsx            # 홈 (메인 화면)
│   ├── onboarding.tsx       # 온보딩 화면
│   └── settings.tsx         # 설정 화면
│
├── src/
│   ├── features/
│   │   └── voice-assistant/
│   │       ├── ui/
│   │       │   ├── VoiceButton.tsx      # 마이크 버튼 (상태 통합)
│   │       │   └── ResponseCard.tsx     # 답변 카드
│   │       ├── model/
│   │       │   ├── useAudioRecorder.ts  # 오디오 녹음 훅
│   │       │   ├── useTTS.ts            # TTS 훅
│   │       │   └── voiceStore.ts        # Zustand 스토어
│   │       └── api/
│   │           ├── transcribe.ts        # Whisper API 호출
│   │           └── generateAnswer.ts    # OpenAI 채팅 호출
│   │
│   ├── shared/
│   │   ├── api/
│   │   │   └── openai.ts    # OpenAI 클라이언트 설정
│   │   ├── config/
│   │   │   ├── prompts.ts   # 시스템 프롬프트
│   │   │   └── constants.ts # 상수 (침묵 시간 등)
│   │   ├── hooks/
│   │   │   └── useSettings.ts # 설정 관리 훅
│   │   ├── ui/
│   │   │   └── Button.tsx   # 공통 버튼
│   │   └── sounds/
│   │       └── effects.ts   # 효과음 관리
│   │
│   └── app.d.ts             # 타입 선언
│
├── assets/
│   ├── sounds/              # 효과음 파일
│   │   ├── start.mp3        # 녹음 시작음
│   │   ├── end.mp3          # 녹음 종료음
│   │   └── processing.mp3   # 처리 중 효과음
│   └── images/              # 이미지
│
├── .env                     # 환경변수 (OPENAI_API_KEY)
├── app.json                 # Expo 설정
├── package.json
└── tsconfig.json
```

---

## 시스템 프롬프트

```typescript
// src/shared/config/prompts.ts

export const SYSTEM_PROMPT = `
당신은 대한민국 도로교통법 전문가 "로드닥"입니다.

## 역할
- 운전자의 도로교통법 관련 질문에 간결하고 정확하게 답변
- 운전 중 듣기 편하도록 짧고 명확하게 응답
- 날씨, 교통상황 등 운전 관련 일반 질문에도 간단히 답변 가능

## 답변 규칙
1. 핵심만 먼저 말하고, 부연 설명은 최소화 (3문장 이내 권장)
2. 벌점/과태료/범칙금이 있으면 함께 안내
3. 확실하지 않은 내용은 "정확한 확인이 필요합니다" 언급
4. 최신 법령 기준으로 답변 (정확한 기준일은 확인 필요 안내)
5. 전문 용어보다 쉬운 말로 설명

## 후속 명령어 처리
사용자가 다음과 같은 의도를 표현하면 적절히 처리:
- "더 자세히", "자세하게" → 이전 답변을 더 상세하게 설명
- "다시 말해", "다시" → 이전 답변을 다시 안내
- "멈춰", "취소", "됐어" → 대화 종료 의도로 이해

## 범위 외 질문 처리
- 도로교통법과 무관한 질문: "저는 도로교통법 전문가입니다. 운전 관련 질문을 해주세요."
- 단, 날씨/교통상황 등 운전과 관련된 일반 질문은 간단히 답변

## 응답 형식
- 존댓말 사용
- 숫자는 명확하게 (예: "시속 50km", "4만원")
- 불필요한 인사말 생략

## 예시
Q: "고속도로 최저 속도가 몇이야?"
A: "고속도로 최저 속도는 시속 50km입니다. 이보다 느리게 주행하면 범칙금 4만원이 부과됩니다."

Q: "비보호 좌회전 어떻게 해?"
A: "비보호 좌회전은 신호가 없거나 좌회전 신호가 꺼졌을 때, 반대편 직진 차량이 없으면 좌회전할 수 있습니다. 반드시 직진 차량에게 양보하세요."

Q: "더 자세히 알려줘"
A: [이전 답변에 대한 상세 설명 - 관련 법 조항, 예외 상황, 주의사항 등 포함]
`;
```

---

## 주요 기능 상세

### 1. 음성 녹음 및 STT

#### 녹음 플로우
1. 마이크 버튼 탭 → 녹음 시작 (시작 효과음 재생)
2. 음성 녹음 진행 (expo-audio)
3. 1.5초 침묵 감지 시 자동 종료 (종료 효과음 재생)
4. 오디오 파일을 Whisper API로 전송
5. 텍스트 변환 완료

#### 오디오 포맷
- iOS: m4a 포맷
- Android: webm 포맷
- 플랫폼별 최적 포맷 자동 선택

#### 에러 처리
- 녹음 실패/인식 불가 시: "음성이 인식되지 않았어요. 다시 말씀해 주세요." (TTS 안내)
- 네트워크 오류 시: 3회 자동 재시도 후 오류 안내

### 2. AI 답변 생성

#### API 설정
- 모델: `gpt-4o-mini`
- Temperature: 0.3 (일관된 답변)
- Max tokens: 150 (기본), 상세 답변 시 300

#### 에러 처리
- API 호출 실패 시: 3회 자동 재시도
- 최종 실패 시: "잠시 후 다시 시도해 주세요" (TTS 안내)

### 3. TTS 출력

#### 설정
- 디바이스 기본 TTS 엔진 사용 (expo-speech)
- 속도: 사용자 설정 가능 (0.5 ~ 2.0, 기본 1.0)
- 언어: 한국어 (ko-KR)

#### 동작
- TTS 재생 중 중단 불가 (사용자 선택)
- TTS 완료 후 대기 상태로 복귀

### 4. 효과음

| 이벤트 | 효과음 | 설명 |
|--------|--------|------|
| 녹음 시작 | 단순 비프음 | 녹음 시작 알림 |
| 녹음 종료 | 단순 비프음 | 인식 완료 알림 |
| 처리 중 | 짧은 효과음 | API 호출 중 알림 |
| 에러 | 다른 톤의 비프음 | 오류 발생 알림 |

---

## 사용자 플로우

```
[앱 최초 실행]
    ↓
[온보딩 화면] - 간단 소개
    ↓
[마이크 권한 요청]
    ↓
[운전 중 사용 안내 팝업] - 면책 조항 동의
    ↓
[홈 화면] - 마이크 버튼 표시
    ↓
[마이크 버튼 탭]
    ↓
[녹음 시작] - 효과음 + 버튼 상태 변경
    ↓
[사용자 질문] - "비보호 좌회전 어떻게 해?"
    ↓
[1.5초 침묵 감지] - 녹음 자동 종료
    ↓
[효과음] - 처리 중 알림
    ↓
[Whisper API 호출] - 음성 → 텍스트
    ↓
[GPT-4o-mini 호출] - 답변 생성
    ↓
[TTS 재생] - 답변을 음성으로 출력
    ↓
[완료] - 다시 대기 상태
```

---

## 화면 구성

### 1. 온보딩 화면 (onboarding.tsx)

```
┌─────────────────────────────┐
│                             │
│         🚗 로드닥           │
│      도로 위 AI 주치의       │
│                             │
│   운전 중 궁금한 도로교통법   │
│   음성으로 물어보세요        │
│                             │
│      [시작하기 버튼]         │
│                             │
└─────────────────────────────┘
```

**동작:**
- 시작하기 탭 → 마이크 권한 요청
- 권한 허용 → 면책 조항 팝업
- 동의 → 홈 화면 이동

### 2. 홈 화면 (index.tsx)

**대기 상태:**
```
┌─────────────────────────────┐
│  ⚙️                    로드닥 │
│                             │
│    ┌───────────────────┐    │
│    │                   │    │
│    │   [세션 대화 목록]  │    │
│    │   Q: 이전 질문      │    │
│    │   A: 이전 답변      │    │
│    │                   │    │
│    └───────────────────┘    │
│                             │
│           🎤               │
│        (회색 버튼)          │
│                             │
│    "탭해서 질문하세요"       │
│                             │
└─────────────────────────────┘
```

**녹음 중 상태:**
```
┌─────────────────────────────┐
│  ⚙️                    로드닥 │
│                             │
│    ┌───────────────────┐    │
│    │                   │    │
│    │   [세션 대화 목록]  │    │
│    │                   │    │
│    │                   │    │
│    └───────────────────┘    │
│                             │
│           🎤               │
│        (빨간색 버튼)         │
│        (펄스 애니메이션)      │
│                             │
│    "듣고 있어요..."         │
│                             │
└─────────────────────────────┘
```

**처리 중 상태:**
```
┌─────────────────────────────┐
│  ⚙️                    로드닥 │
│                             │
│    ┌───────────────────┐    │
│    │                   │    │
│    │   [세션 대화 목록]  │    │
│    │                   │    │
│    │                   │    │
│    └───────────────────┘    │
│                             │
│           ⏳               │
│        (로딩 버튼)          │
│                             │
│    "답변 준비 중..."        │
│                             │
└─────────────────────────────┘
```

**재생 중 상태:**
```
┌─────────────────────────────┐
│  ⚙️                    로드닥 │
│                             │
│    ┌───────────────────┐    │
│    │ Q: 비보호 좌회전    │    │
│    │    어떻게 해?       │    │
│    ├───────────────────┤    │
│    │ A: 비보호 좌회전은  │    │
│    │ 신호가 없거나...    │    │
│    └───────────────────┘    │
│                             │
│           🔊               │
│        (재생 중 버튼)        │
│                             │
│    "답변 중..."            │
│                             │
└─────────────────────────────┘
```

### 3. 설정 화면 (settings.tsx)

```
┌─────────────────────────────┐
│  ←                    설정   │
│                             │
│  ─────────────────────────  │
│  음성 설정                   │
│  ─────────────────────────  │
│                             │
│  TTS 속도                   │
│  느림 ────●──────── 빠름     │
│                             │
│  침묵 감지 시간              │
│  [1.5초 ▼]                  │
│                             │
│  ─────────────────────────  │
│  화면 설정                   │
│  ─────────────────────────  │
│                             │
│  다크 모드                   │
│  [시스템 설정 따름 ▼]        │
│                             │
│  ─────────────────────────  │
│  앱 정보                     │
│  ─────────────────────────  │
│                             │
│  버전: 0.1.0                 │
│                             │
└─────────────────────────────┘
```

**설정 옵션:**
- TTS 속도: 0.5 ~ 2.0 (슬라이더)
- 침묵 감지 시간: 1초, 1.5초, 2초 (드롭다운)
- 다크 모드: 시스템 설정 따름, 라이트, 다크 (드롭다운)

---

## 상태 관리 (Zustand)

```typescript
// src/features/voice-assistant/model/voiceStore.ts

interface VoiceState {
  // 앱 상태
  status: 'idle' | 'recording' | 'processing' | 'speaking';

  // 현재 세션 대화
  conversations: Array<{
    id: string;
    question: string;
    answer: string;
    timestamp: Date;
  }>;

  // 마지막 대화 (후속 질문용)
  lastConversation: {
    question: string;
    answer: string;
  } | null;

  // 에러 상태
  error: string | null;

  // 액션
  setStatus: (status: VoiceState['status']) => void;
  addConversation: (question: string, answer: string) => void;
  clearConversations: () => void;
  setError: (error: string | null) => void;
}
```

---

## API 보안

### MVP 단계
- 클라이언트에 API 키 직접 포함 (EXPO_PUBLIC_OPENAI_API_KEY)
- OpenAI 대시보드에서 rate limit 설정
- 위험성 인지하고 감수

### 추후 개선 (Post-MVP)
- 백엔드 프록시 서버 구축
- 또는 Cloudflare Workers 등 엣지 함수 사용

---

## 환경 변수

```env
# .env
EXPO_PUBLIC_OPENAI_API_KEY=sk-xxxx
```

---

## 개발 순서

### Phase 1: 프로젝트 셋업
- [x] Expo 프로젝트 생성
- [x] 패키지 설치
- [x] 폴더 구조 세팅
- [x] 기본 UI 레이아웃 (심플 그레이 테마)
- [x] 다크 모드 지원 (시스템 설정 따름)

### Phase 2: 온보딩 & 설정
- [x] 온보딩 화면 구현
- [x] 마이크 권한 요청 플로우
- [x] 면책 조항 팝업
- [x] 설정 화면 구현 (TTS 속도, 침묵 시간, 다크모드)

### Phase 3: 음성 기능
- [x] expo-audio로 녹음 구현
- [x] 침묵 감지 로직 (1.5초 기본)
- [x] 플랫폼별 오디오 포맷 처리
- [x] Whisper API 연동
- [x] TTS 구현 (expo-speech)
- [x] 효과음 구현 (햅틱 피드백으로 대체)

### Phase 4: AI 연동
- [x] OpenAI 클라이언트 설정
- [x] 시스템 프롬프트 적용
- [x] GPT-4o-mini API 호출
- [x] 후속 명령어 처리 (자연어)
- [x] 에러 처리 (3회 재시도)

### Phase 5: 통합 및 테스트
- [x] 전체 플로우 연결
- [x] Zustand 상태 관리 통합
- [x] 에러 처리 완성
- [x] UI 다듬기
- [ ] iOS 실기기 테스트
- [ ] Android 실기기 테스트

### Phase 6: UI 현대화 (NativeWind/Tailwind CSS + gluestack-ui v3)
- [x] NativeWind 설치 및 초기 설정
  - [x] NativeWind (Tailwind CSS) 설정
  - [x] 테마 설정 (다크모드 연동)
- [x] 화면별 마이그레이션
  - [x] 온보딩 화면 (onboarding.tsx)
  - [x] 홈 화면 (index.tsx)
  - [x] 설정 화면 (settings.tsx)
- [x] 커스텀 컴포넌트 리팩토링
  - [x] VoiceButton 컴포넌트
  - [x] StatusDisplay 컴포넌트
- [x] 애니메이션 개선
  - [x] 화면 전환 애니메이션
  - [x] 마이크로 인터랙션
- [x] gluestack-ui v3 스타일 컴포넌트 구축
  - [x] GluestackUIProvider
  - [x] Button 컴포넌트 (variants: solid, outline, ghost, link)
  - [x] Card 컴포넌트 (variants: elevated, outline, ghost, filled)
  - [x] Modal 컴포넌트 (ModalContent, ModalHeader, ModalBody, ModalFooter)
  - [x] Actionsheet 컴포넌트 (바텀시트 스타일)
  - [x] Box, Text 컴포넌트

---

## 테스트 계획

### MVP 테스트 방식
- 실기기 수동 테스트 (iOS + Android 동시)
- 자동화 테스트는 Post-MVP에서 검토

### 테스트 체크리스트
- [ ] 마이크 권한 요청 정상 동작
- [ ] 음성 녹음 시작/종료
- [ ] 침묵 감지 자동 종료
- [ ] Whisper API 호출 성공
- [ ] GPT 답변 수신
- [ ] TTS 재생
- [ ] 햅틱 피드백 동작
- [ ] 후속 명령어 처리 ("더 자세히", "다시 말해")
- [ ] 네트워크 오류 시 재시도
- [ ] 설정 변경 반영

---

## 면책 조항 (앱 내 표시)

```
본 앱은 도로교통법에 대한 일반적인 정보를 제공하며,
법률 자문을 대체하지 않습니다.

정확한 법률 내용은 국가법령정보센터 또는
관할 기관에서 확인하시기 바랍니다.

운전 중에는 안전에 유의하시고,
가능하면 정차 후 사용해 주세요.
```

---

## 추후 확장 (Post-MVP)

| 우선순위 | 기능 | 설명 |
|---------|------|------|
| 1 | Siri/Google Assistant 연동 | "시리야, 로드닥한테 물어봐" |
| 2 | RAG | Supabase pgvector로 실제 법령 데이터 검색 |
| 3 | 대화 히스토리 저장 | 이전 질문/답변 로컬 저장 및 검색 |
| 4 | 오프라인 모드 | 자주 묻는 질문 로컬 캐시 |
| 5 | 오디오 덕킹 | 음악/네비 볼륨 자동 조절 |
| 6 | 백엔드 프록시 | API 키 보안 강화 |

---

## UI/UX 가이드라인

### 색상 테마
- 기본: 심플한 그레이 톤
- 다크 모드: 시스템 설정 따름

### 마이크 버튼 상태별 색상
| 상태 | 색상 | 애니메이션 |
|------|------|-----------|
| 대기 (idle) | 회색 | 없음 |
| 녹음 중 (recording) | 빨간색 | 펄스 |
| 처리 중 (processing) | 파란색 | 로딩 스피너 |
| 재생 중 (speaking) | 초록색 | 파동 |

### 앱 아이콘 & 스플래시
- 앱 아이콘: 추후 결정 (MVP는 Expo 기본)
- 스플래시: Expo 기본 사용

---

## 참고 자료

- 도로교통법: https://law.go.kr/법령/도로교통법
- Expo Audio: https://docs.expo.dev/versions/latest/sdk/audio/
- Expo Speech: https://docs.expo.dev/versions/latest/sdk/speech/
- OpenAI Whisper API: https://platform.openai.com/docs/guides/speech-to-text
- OpenAI Chat API: https://platform.openai.com/docs/guides/chat
- Zustand: https://github.com/pmndrs/zustand
